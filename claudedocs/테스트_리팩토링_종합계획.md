# 테스트 리팩토링 종합 계획서

> **프로젝트 범위**: Modern ML Pipeline 테스트 코드 전면 리팩토링
> **목적**: CLI/Settings 대대적 리팩토링 후 테스트-소스 코드 불일치 해결
> **준수 원칙**: `/tests/README.md` 구조적 원칙 완전 준수
> **작성일**: 2025년 9월 13일

---

## 📋 목차

1. [개요 및 현황](#1-개요-및-현황)
2. [중대 문제점 분석](#2-중대-문제점-분석)
3. [3단계 리팩토링 계획](#3-3단계-리팩토링-계획)
4. [파일별 상세 변경사항](#4-파일별-상세-변경사항)
5. [아키텍처 준수 가이드](#5-아키텍처-준수-가이드)
6. [구현 타임라인](#6-구현-타임라인)
7. [성공 기준 및 검증](#7-성공-기준-및-검증)

---

## 1. 개요 및 현황

### 1.1 리팩토링 배경

**완료된 소스 코드 변경사항:**
- ✅ **CLI 명령어 8개 전체 리팩토링**: Logger 기반 → Rich Console 기반 전환
- ✅ **설정 시스템 통합**: `config_loader.py` 완전 삭제, 기능을 `settings/factory.py`로 통합
- ✅ **CLI 유틸리티 현대화**: `config_builder.py`, `system_checker.py`, `interactive_ui.py` 대폭 수정
- ✅ **콘솔 출력 일관화**: `console_manager.py` 중심의 통합 출력 시스템

**테스트 코드 현황:**
- 📊 **총 테스트 파일**: 88개
- 📊 **소스 코드 파일**: 116개
- ⚠️ **추정 불일치율**: 60%+ (CLI/Settings 모듈 중심)
- ❌ **즉시 실패 예상**: Import 에러, 시그니처 불일치, 출력 패턴 변경

### 1.2 tests/README.md 준수 원칙

**핵심 아키텍처 요구사항:**
```
tests/
├── conftest.py                     # 공용 픽스처 등록
├── fixtures/
│   ├── contexts/                   # Context 클래스 (MLflow, Database, Component)
│   ├── templates/                  # 테스트 전용 YAML 템플릿
│   └── expected/                   # 기대 산출물
├── integration/                    # 통합/시나리오 테스트
└── unit/                          # 단위 테스트
```

**현재 위반 사항:**
- `tests/unit/settings/fixtures/` → `tests/fixtures/`로 이동 필요
- Context 클래스 미사용: 수동 설정 대신 `MLflowTestContext` 등 활용 필요
- 픽스처 중복: `config_examples.py`, `recipe_examples.py` 중복 존재

---

## 2. 중대 문제점 분석

### 2.1 🔴 CRITICAL (시스템 차단 수준)

#### **A. 삭제된 모듈 Import 오류**
```python
# ❌ 실패할 Import들
from src.cli.utils.config_loader import load_config_with_env  # 모듈 삭제됨
from src.cli.utils.config_loader import resolve_env_variables
```
**영향받는 파일:**
- `tests/unit/cli/test_config_loader_phase1.py` (전체 삭제 또는 리다이렉션)
- `tests/unit/cli/test_config_loader_simple.py` (전체 삭제 또는 리다이렉션)

#### **B. CLI 출력 패턴 불일치**
```python
# ❌ 기존 테스트 (실패함)
assert "Training completed" in caplog.records[-1].message

# ✅ 새로운 패턴 (Rich Console)
assert mock_console.called_with("cli_command_success", "Training completed")
```
**영향받는 파일:** CLI 관련 모든 테스트 파일 (12개)

#### **C. SystemChecker 반환 형식 변경**
```python
# ❌ 기존 반환: List[SystemCheckResult]
# ✅ 새 반환: Dict[str, Dict[str, Any]]
```
**영향받는 파일:**
- `tests/unit/cli/test_system_checker.py`
- `tests/integration/test_component_interactions.py`

### 2.2 🟡 HIGH PRIORITY (아키텍처 위반)

#### **A. 픽스처 위치 위반**
```
# ❌ 현재 (위반)
tests/unit/settings/fixtures/test_config_examples.py
tests/unit/settings/fixtures/test_recipe_examples.py

# ✅ tests/README.md 준수
tests/fixtures/config_examples.py (통합)
tests/fixtures/recipe_examples.py (통합)
```

#### **B. Context 클래스 미사용**
```python
# ❌ 현재 패턴 (수동 설정)
temp_dir = tempfile.mkdtemp()
mlflow.set_tracking_uri(f"file://{temp_dir}/mlruns")

# ✅ tests/README.md 준수
with mlflow_test_context.for_classification() as ctx:
    mlflow.set_tracking_uri(ctx.mlflow_uri)
```

### 2.3 🟢 MEDIUM PRIORITY (커버리지 갭)

#### **A. 누락된 CLI 명령어 테스트**
- `src/cli/commands/get_config_command.py` → 테스트 없음
- `src/cli/commands/get_recipe_command.py` → 테스트 없음
- `src/cli/commands/serve_command.py` → 테스트 없음
- `src/cli/commands/system_check_command.py` → 테스트 없음

#### **B. 확장된 Factory 모듈 테스트 부족**
- `src/factory/factory.py` (37KB) → 기존 테스트가 새 기능 커버 안 함
- `src/settings/factory.py` (17KB) → SettingsFactory 패턴 테스트 부족

---

## 3. 3단계 리팩토링 계획

### Phase 1: 긴급 수정 (Critical Fixes) - 1주차

**목표**: 테스트 실행 가능 상태 복원

#### **1.1 Import 오류 해결**
```bash
# 삭제 또는 리다이렉션
rm tests/unit/cli/test_config_loader_phase1.py
rm tests/unit/cli/test_config_loader_simple.py

# 또는 settings/factory.py 테스트로 통합
mv tests/unit/cli/test_config_loader_*.py tests/unit/settings/
```

#### **1.2 CLI 테스트 출력 패턴 업데이트**
```python
# 모든 CLI 테스트에서 변경
# Before:
def test_train_command_success(caplog):
    result = runner.invoke(train_command)
    assert "Training started" in caplog.records[0].message

# After:
def test_train_command_success(mock_console):
    with patch('src.cli.commands.train_command.cli_command_start') as mock_start:
        result = runner.invoke(train_command)
        mock_start.assert_called_with("Train Command", ["Starting model training"])
```

#### **1.3 SystemChecker 테스트 수정**
```python
# tests/unit/cli/test_system_checker.py
def test_system_checker_returns_dict():
    checker = SystemChecker(config, "test", "/path/to/config")
    results = checker.run_all_checks()

    # 새 반환 형식 검증
    assert isinstance(results, dict)
    for component, result in results.items():
        assert 'status' in result
        assert 'message' in result
        assert result['status'] in ['success', 'error', 'warning']
```

### Phase 2: 아키텍처 정렬 (Architecture Alignment) - 2주차

**목표**: tests/README.md 완전 준수

#### **2.1 픽스처 재조직화**
```bash
# 이동 및 통합
mv tests/unit/settings/fixtures/test_config_examples.py tests/fixtures/
mv tests/unit/settings/fixtures/test_recipe_examples.py tests/fixtures/

# 중복 제거 및 통합
# tests/fixtures/config_examples.py와 이동된 파일들 병합
```

#### **2.2 Context 클래스 통합**
```python
# MLflowTestContext 적용 예시
@pytest.fixture
def mlflow_test_context():
    return MLflowTestContext()

def test_train_pipeline_with_context(mlflow_test_context):
    with mlflow_test_context.for_classification() as ctx:
        result = run_train_pipeline(ctx.settings, ctx.data_path)
        assert ctx.experiment_exists()
        assert ctx.get_experiment_run_count() == 1
```

#### **2.3 Console Manager 함수 테스트**
```python
# 새 파일: tests/unit/utils/core/test_console_manager_cli.py
def test_cli_command_start():
    with patch('rich.console.Console.print') as mock_print:
        cli_command_start("Test Command", ["Step 1", "Step 2"])
        assert mock_print.called

def test_cli_success_panel():
    with patch('rich.console.Console.print') as mock_print:
        cli_success_panel("Success message", "Title")
        assert mock_print.called
```

### Phase 3: 커버리지 완성 (Coverage Completion) - 3주차

**목표**: 누락된 테스트 추가 및 확장

#### **3.1 누락된 CLI 명령어 테스트**
```python
# 새 파일들 생성
tests/unit/cli/test_get_config_command.py
tests/unit/cli/test_get_recipe_command.py
tests/unit/cli/test_serve_command.py
tests/unit/cli/test_system_check_command.py
```

#### **3.2 Factory 확장 테스트**
```python
# tests/unit/factory/test_factory_expanded.py
def test_settings_factory_integration():
    # 새 SettingsFactory 패턴 테스트
    factory = SettingsFactory()
    settings = factory.load_with_environment("local")
    assert settings.environment.name == "local"

def test_component_factory_new_methods():
    # factory.py의 새 메소드들 테스트
    pass
```

#### **3.3 통합 테스트 검증**
```python
# 모든 integration/ 테스트에서 Context 사용 확인
# 리팩토링된 CLI 명령어들과의 호환성 검증
```

---

## 4. 파일별 상세 변경사항

### 4.1 즉시 삭제/이동 대상

#### **삭제 대상**
```bash
# config_loader 관련 (모듈 삭제로 무효)
rm tests/unit/cli/test_config_loader_phase1.py
rm tests/unit/cli/test_config_loader_simple.py
```

#### **이동 대상**
```bash
# 픽스처 정리
mv tests/unit/settings/fixtures/test_config_examples.py tests/fixtures/
mv tests/unit/settings/fixtures/test_recipe_examples.py tests/fixtures/
rmdir tests/unit/settings/fixtures/  # 빈 디렉토리 제거
```

### 4.2 수정 대상 (기존 파일)

#### **CLI 테스트 파일들 (12개)**
```
tests/unit/cli/test_train_command.py          → Rich Console 패턴으로 수정
tests/unit/cli/test_inference_command.py      → Rich Console 패턴으로 수정
tests/unit/cli/test_init_command.py          → Rich Console 패턴으로 수정
tests/unit/cli/test_list_commands.py         → Rich Console 패턴으로 수정
tests/unit/cli/test_system_checker.py        → Dict 반환 형식으로 수정
... (나머지 CLI 테스트들)
```

**수정 템플릿:**
```python
# Before (Logger 기반)
def test_command_execution(caplog):
    runner = CliRunner()
    result = runner.invoke(command_func, [])
    assert "Expected message" in caplog.records[0].message

# After (Rich Console 기반)
@patch('src.cli.commands.command_file.cli_command_start')
@patch('src.cli.commands.command_file.cli_command_success')
def test_command_execution(mock_success, mock_start):
    runner = CliRunner()
    result = runner.invoke(command_func, [])
    mock_start.assert_called_with("Command Name", mock.ANY)
    mock_success.assert_called_with("Command Name", mock.ANY)
```

#### **Integration 테스트 파일들 (7개)**
```
tests/integration/test_mlflow_integration.py     → Context 클래스 적용
tests/integration/test_component_interactions.py → Factory 새 시그니처 적용
tests/integration/test_pipeline_orchestration.py → CLI 리팩토링 반영
... (모든 integration 테스트)
```

### 4.3 신규 생성 대상

#### **누락된 CLI 테스트 (4개)**
```python
# tests/unit/cli/test_get_config_command.py
"""get-config 명령어 테스트 - SimpleInteractiveUI 패턴 검증"""

class TestGetConfigCommand:
    def test_config_generation_success(self):
        # config_builder.py의 SimpleInteractiveUI 테스트
        pass

    def test_template_rendering(self):
        # Jinja2 템플릿 렌더링 테스트
        pass

# tests/unit/cli/test_get_recipe_command.py
"""get-recipe 명령어 테스트 - 레시피 템플릿 생성 검증"""

# tests/unit/cli/test_serve_command.py
"""serve 명령어 테스트 - Rich Console 서버 시작 패턴"""

# tests/unit/cli/test_system_check_command.py
"""system-check 명령어 테스트 - 인라인 load_environment 함수"""
```

#### **Console Manager CLI 함수 테스트**
```python
# tests/unit/utils/core/test_console_manager_cli_functions.py
"""console_manager.py의 CLI 전용 함수들 테스트"""

class TestConsoleManagerCLI:
    def test_cli_command_start(self):
        # cli_command_start() 함수 테스트
        pass

    def test_cli_command_success(self):
        # cli_command_success() 함수 테스트
        pass

    def test_cli_success_panel(self):
        # cli_success_panel() 함수 테스트
        pass

    def test_cli_validation_summary(self):
        # cli_validation_summary() 함수 테스트
        pass

    # ... 15개 CLI 함수 전체 테스트
```

---

## 5. 아키텍처 준수 가이드

### 5.1 Context 클래스 사용 패턴

#### **MLflowTestContext 적용**
```python
# ❌ 기존 패턴 (수동 설정)
def test_mlflow_integration():
    temp_dir = tempfile.mkdtemp()
    tracking_uri = f"file://{temp_dir}/mlruns"
    mlflow.set_tracking_uri(tracking_uri)

    # 테스트 로직

    shutil.rmtree(temp_dir)  # 수동 정리

# ✅ Context 패턴 (tests/README.md 준수)
def test_mlflow_integration(mlflow_test_context):
    with mlflow_test_context.for_classification() as ctx:
        mlflow.set_tracking_uri(ctx.mlflow_uri)

        # 테스트 로직
        result = run_train_pipeline(ctx.settings, ctx.data_path)

        # Context 헬퍼 활용
        assert ctx.experiment_exists()
        assert ctx.get_experiment_run_count() == 1
        metrics = ctx.get_run_metrics()
        assert isinstance(metrics, dict)
    # 자동 정리됨
```

#### **ComponentTestContext 적용**
```python
# ✅ Factory 컴포넌트 테스트 패턴
def test_component_interaction(component_test_context):
    with component_test_context.classification_stack() as ctx:
        raw_df = ctx.adapter.read(ctx.data_path)
        processed_df = ctx.prepare_model_input(raw_df)

        # Context 검증 헬퍼 활용
        assert ctx.validate_data_flow(raw_df, processed_df)
```

### 5.2 픽스처 조직화 가이드

#### **tests/fixtures/ 구조**
```
tests/fixtures/
├── contexts/
│   ├── mlflow_context.py       # MLflowTestContext
│   ├── component_context.py    # ComponentTestContext
│   └── database_context.py     # DatabaseTestContext
├── templates/
│   └── configs/                # 테스트 전용 YAML (최소한만)
├── expected/
│   └── metrics/                # 기준 산출물 (필요한 것만)
├── config_examples.py          # 통합된 Config 예제
└── recipe_examples.py          # 통합된 Recipe 예제
```

#### **Conftest.py 등록**
```python
# tests/conftest.py
@pytest.fixture
def mlflow_test_context():
    return MLflowTestContext()

@pytest.fixture
def component_test_context():
    return ComponentTestContext()

@pytest.fixture
def database_test_context():
    return DatabaseTestContext()
```

### 5.3 Rich Console 테스트 패턴

#### **CLI 출력 검증 표준**
```python
# Mock을 활용한 Rich Console 함수 테스트
@patch('src.cli.commands.train_command.cli_command_start')
@patch('src.cli.commands.train_command.cli_success_panel')
@patch('src.cli.commands.train_command.cli_command_success')
def test_train_command_rich_console(mock_success, mock_panel, mock_start):
    runner = CliRunner()
    result = runner.invoke(train_command, ['--config', 'test.yaml'])

    # 시작 메시지 검증
    mock_start.assert_called_once_with("Train Command", mock.ANY)

    # 성공 패널 검증 (예상되는 경우)
    if result.exit_code == 0:
        mock_panel.assert_called()
        mock_success.assert_called_once()
```

#### **Console Manager 함수 직접 테스트**
```python
def test_cli_command_start():
    with patch('src.utils.core.console_manager.get_rich_console') as mock_console:
        console_instance = Mock()
        mock_console.return_value = console_instance

        cli_command_start("Test Command", ["Step 1"])

        # Rich Console 호출 검증
        console_instance.print.assert_called()
        console_instance.progress_tracker.assert_called()
```

---

## 6. 구현 타임라인

### 6.1 Phase 1: 긴급 수정 (1주차)

#### **Day 1-2: Import 오류 해결**
- [x] `test_config_loader_*` 파일들 처리 결정
- [ ] CLI 테스트들의 import 문 수정
- [ ] 즉시 실행 가능한 상태로 복원

#### **Day 3-4: SystemChecker 테스트 수정**
- [ ] `test_system_checker.py` 반환 형식 변경
- [ ] Integration 테스트의 SystemChecker 호출 부분 수정

#### **Day 5-7: CLI 출력 패턴 기본 수정**
- [ ] `test_train_command.py` Rich Console 패턴 적용
- [ ] `test_inference_command.py` Rich Console 패턴 적용
- [ ] 나머지 CLI 테스트들 순차 적용

### 6.2 Phase 2: 아키텍처 정렬 (2주차)

#### **Day 8-10: 픽스처 재조직화**
- [ ] `tests/unit/settings/fixtures/` → `tests/fixtures/` 이동
- [ ] 중복 픽스처 통합
- [ ] 모든 import 경로 업데이트

#### **Day 11-12: Context 클래스 기본 적용**
- [ ] `conftest.py`에 Context 픽스처 등록
- [ ] 주요 Integration 테스트에 Context 적용
- [ ] MLflow 관련 테스트 Context 전환

#### **Day 13-14: Console Manager 테스트**
- [ ] `test_console_manager_cli_functions.py` 생성
- [ ] 15개 CLI 함수 테스트 작성
- [ ] Rich Console Mock 패턴 확립

### 6.3 Phase 3: 커버리지 완성 (3주차)

#### **Day 15-17: 누락 CLI 테스트 생성**
- [ ] `test_get_config_command.py` - SimpleInteractiveUI 테스트
- [ ] `test_get_recipe_command.py` - 템플릿 렌더링 테스트
- [ ] `test_serve_command.py` - 서버 시작 Rich Console 테스트
- [ ] `test_system_check_command.py` - 인라인 함수 테스트

#### **Day 18-19: Factory 확장 테스트**
- [ ] `test_settings_factory_expanded.py` 생성
- [ ] `test_factory_new_patterns.py` 생성
- [ ] 37KB factory.py의 새 기능들 테스트

#### **Day 20-21: 통합 검증 및 정리**
- [ ] 모든 Integration 테스트 Context 전환 완료
- [ ] E2E 테스트 시나리오 검증
- [ ] 테스트 실행 속도 최적화

---

## 7. 성공 기준 및 검증

### 7.1 단계별 성공 기준

#### **Phase 1 완료 기준**
- ✅ `pytest tests/unit/cli/` 실행 시 Import 오류 0건
- ✅ SystemChecker 관련 테스트 모두 통과
- ✅ 기본 CLI 테스트들 Rich Console 패턴으로 실행 성공

#### **Phase 2 완료 기준**
- ✅ `tests/fixtures/` 구조가 `tests/README.md` 완전 준수
- ✅ 주요 Integration 테스트에서 Context 클래스 사용
- ✅ Console Manager의 15개 CLI 함수 모두 테스트됨

#### **Phase 3 완료 기준**
- ✅ 모든 CLI 명령어에 대응하는 테스트 존재
- ✅ Factory 모듈 확장 기능 테스트 커버리지 90%+
- ✅ 전체 테스트 스위트 실행 시간 20분 이내

### 7.2 최종 검증 체크리스트

#### **아키텍처 준수 검증**
- [ ] 픽스처가 `tests/fixtures/` 아래에만 존재
- [ ] Context 클래스가 Integration 테스트에서 활용됨
- [ ] MLflow 테스트가 `file://` URI와 UUID 명명 사용
- [ ] 테스트 격리가 보장됨 (상태 공유 없음)

#### **기능 검증**
- [ ] 모든 CLI 명령어가 Rich Console 출력 패턴으로 테스트됨
- [ ] 리팩토링된 Factory 패턴이 모두 테스트됨
- [ ] Settings 로딩이 새 factory.py 경로로 테스트됨
- [ ] SystemChecker의 새 Dict 반환 형식 검증됨

#### **성능 및 품질 검증**
- [ ] `pytest -n auto` 병렬 실행 성공
- [ ] 테스트 커버리지 85% 이상 유지
- [ ] Flaky 테스트 0건
- [ ] CI/CD 파이프라인 통과

### 7.3 롤백 계획

각 Phase별로 Git 커밋을 세분화하여 문제 발생 시 단계적 롤백 가능:

```bash
# Phase 1 커밋들
git commit -m "Phase1: Fix import errors from deleted config_loader"
git commit -m "Phase1: Update SystemChecker test return format"
git commit -m "Phase1: Convert CLI tests to Rich Console patterns"

# Phase 2 커밋들
git commit -m "Phase2: Reorganize fixtures per tests/README.md"
git commit -m "Phase2: Integrate Context classes in integration tests"
git commit -m "Phase2: Add console_manager CLI functions tests"

# Phase 3 커밋들
git commit -m "Phase3: Add missing CLI command tests"
git commit -m "Phase3: Expand factory module test coverage"
git commit -m "Phase3: Final integration test verification"
```

---

## 8. 부록

### 8.1 주요 변경 모듈 매핑

| **소스 모듈** | **변경 유형** | **테스트 영향도** | **대응 전략** |
|--------------|-------------|----------------|-------------|
| `src/cli/commands/*.py` (8개) | Rich Console 전환 | 🔴 HIGH | 출력 패턴 재테스트 |
| `src/cli/utils/config_loader.py` | 완전 삭제 | 🔴 CRITICAL | 테스트 삭제/이동 |
| `src/cli/utils/system_checker.py` | 반환형 변경 | 🟡 MEDIUM | 반환형 검증 수정 |
| `src/cli/utils/config_builder.py` | UI 클래스 교체 | 🟡 MEDIUM | 신규 테스트 생성 |
| `src/settings/factory.py` | 대폭 확장 | 🟡 MEDIUM | 확장 기능 테스트 |
| `src/utils/core/console_manager.py` | 15개 함수 추가 | 🟢 LOW | 신규 테스트 생성 |

### 8.2 테스트 카테고리별 우선순위

| **카테고리** | **파일 수** | **우선순위** | **완료 목표** |
|-------------|-----------|------------|-------------|
| CLI 명령어 테스트 | 12개 | 🔴 P0 | Phase 1 |
| Settings/Factory 테스트 | 8개 | 🟡 P1 | Phase 2 |
| Integration 테스트 | 7개 | 🟡 P1 | Phase 2 |
| Component 테스트 | 25개 | 🟢 P2 | Phase 3 |
| Utils/Core 테스트 | 15개 | 🟢 P2 | Phase 3 |

### 8.3 Context 클래스 활용 예시

#### **MLflowTestContext 고급 사용법**
```python
def test_complex_mlflow_scenario(mlflow_test_context):
    # 복잡한 MLflow 시나리오 테스트
    with mlflow_test_context.for_classification(
        experiment="advanced_test",
        tags={"version": "2.0", "environment": "test"}
    ) as ctx:
        # 다중 실행 테스트
        for i in range(3):
            run_train_pipeline(ctx.settings, ctx.data_path)

        # Context 헬퍼로 검증
        assert ctx.get_experiment_run_count() == 3

        runs = ctx.get_all_runs()
        for run in runs:
            assert run.data.tags.get("version") == "2.0"
```

#### **DatabaseTestContext 활용**
```python
def test_database_integration(database_test_context):
    test_data = pd.DataFrame({
        'user_id': [1, 2, 3],
        'feature_1': [0.1, 0.2, 0.3],
        'target': [1, 0, 1]
    })

    with database_test_context.sqlite_db({
        "users": test_data
    }) as db:
        # DB 연결 테스트
        adapter = create_sql_adapter(db.connection_uri)
        result = adapter.read("SELECT * FROM users")

        assert len(result) == 3
        assert db.table_exists("users")
```

---

**최종 업데이트**: 2025년 9월 13일
**담당자**: Claude Code Assistant
**승인 필요**: 사용자 확인 후 구현 시작