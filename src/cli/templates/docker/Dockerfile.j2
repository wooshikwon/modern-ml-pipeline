# Multi-stage Dockerfile for {{ project_name }}
# Generated by Modern ML Pipeline

###########################################
# Stage 1: Base Python Environment
###########################################
FROM python:3.11-slim as base

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

###########################################
# Stage 2: Builder
###########################################
FROM base as builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# 프로젝트 메타데이터 복사
COPY pyproject.toml README.md ./

# 패키지 설치 (standard extras 포함)
RUN pip install -e ".[standard]"

###########################################
# Stage 3: Runtime
###########################################
FROM base as runtime

# 빌더에서 설치된 패키지 복사
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# 런타임 의존성
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# 비root 사용자 생성
RUN groupadd -r mluser && useradd -r -g mluser -d /home/mluser -s /bin/bash mluser

# 애플리케이션 디렉토리 준비
RUN mkdir -p /app/mlruns /app/logs /app/artifacts /app/data && \
    chown -R mluser:mluser /app

WORKDIR /app

# 설정 파일 복사
COPY --chown=mluser:mluser configs/ ./configs/
COPY --chown=mluser:mluser recipes/ ./recipes/
COPY --chown=mluser:mluser sql/ ./sql/
COPY --chown=mluser:mluser data/ ./data/

USER mluser

ENV PROJECT_NAME={{ project_name }} \
    PYTHONPATH=/app:$PYTHONPATH \
    MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-./mlruns}

###########################################
# Stage 4: API Serving
###########################################
FROM runtime as api

USER root
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*
USER mluser

EXPOSE 8000

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/ready || exit 1

CMD ["sh", "-c", "mmp serve-api --run-id ${MODEL_RUN_ID} --config ${CONFIG_PATH:-configs/production.yaml} --host 0.0.0.0 --port 8000"]

###########################################
# Stage 5: Training
###########################################
FROM runtime as training

CMD ["sh", "-c", "mmp train --recipe ${RECIPE_PATH:-recipes/model.yaml} --config ${CONFIG_PATH:-configs/production.yaml} --data ${TRAIN_DATA_PATH:-data/train.csv}"]

###########################################
# Stage 6: Batch Inference
###########################################
FROM runtime as inference

CMD ["sh", "-c", "mmp batch-inference --run-id ${MODEL_RUN_ID} --config ${CONFIG_PATH:-configs/production.yaml} --data ${INFERENCE_DATA_PATH}"]

###########################################
# Default: API Serving
###########################################
FROM api as final
