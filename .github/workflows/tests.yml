name: Tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ feature/* ]

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run unit tests (full)
        run: |
          pytest -q tests/unit
          pytest -q tests/unit/settings/test_settings_validation.py::TestRecipeValidation::test_recipe_validation_timeseries_requires_timestamp

  integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run integration tests
        run: pytest -q tests/integration -m "not slow"

  v2_pilot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run v2 context tests
        run: |
          pytest -q tests/integration/test_mlflow_integration.py::TestMLflowIntegration::test_mlflow_experiment_creation_and_tracking_v2
          pytest -q tests/integration/test_mlflow_integration.py::TestMLflowIntegration::test_mlflow_model_logging_and_registration_v2
          pytest -q tests/integration/test_mlflow_integration.py::TestMLflowIntegration::test_mlflow_artifact_logging_and_retrieval_v2
          pytest -q tests/integration/test_mlflow_integration.py::TestMLflowIntegration::test_mlflow_artifact_equivalence_old_vs_new
          pytest -q tests/integration/test_mlflow_integration.py::TestMLflowIntegration::test_mlflow_metrics_keys_match_baseline_v2
          pytest -q tests/integration/test_component_interactions.py::TestComponentDataFlowValidation::test_adapter_to_model_data_flow_integration_v2
          pytest -q tests/integration/test_database_integration.py::TestDatabaseIntegration::test_sql_adapter_read_v2
