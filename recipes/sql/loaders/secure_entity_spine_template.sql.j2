-- ğŸ†• Phase 3: ë³´ì•ˆ ê°•í™” Entity Spine í‘œì¤€ í…œí”Œë¦¿
-- Point-in-Time Correctness + SQL Injection ë°©ì§€ + Context Params í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜

SELECT 
    -- ğŸ¯ Phase 1 LoaderDataInterface í•„ìˆ˜ ì»¬ëŸ¼ë“¤
    -- Entity ì»¬ëŸ¼ë“¤ (Primary Key ì—­í• )
    user_id,
    product_id,
    merchant_id,
    
    -- ğŸ¯ Timestamp ì»¬ëŸ¼ (Point-in-Time JOIN ê¸°ì¤€)
    event_timestamp,
    
    -- ğŸ”„ ë™ì  Target ì»¬ëŸ¼ (Training/Inference ë¶„ê¸°)
    {% if include_target | default(true) %}
    target_class as target,
    {% endif %}
    
    -- ğŸ“Š ì¶”ê°€ Feature ì»¬ëŸ¼ë“¤
    transaction_amount,
    merchant_category,
    user_country_code,
    device_type,
    
    -- ğŸ•’ ì‹œì  ì •ë³´ (ë””ë²„ê¹… ë° ì¶”ì ìš©)
    '{{ start_date | default('2024-01-01') }}' as spine_start_date,
    '{{ end_date | default('2024-12-31') }}' as spine_end_date

FROM user_transactions_fact 

WHERE 
    -- ğŸ“… ë‚ ì§œ ë²”ìœ„ í•„í„° (Context Params í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜)
    event_timestamp >= '{{ start_date | default('2024-01-01') }}'
    AND event_timestamp < '{{ end_date | default('2024-12-31') }}'
    
    -- ğŸ”’ ë¯¸ë˜ ë°ì´í„° ëˆ„ì¶œ ë°©ì§€ (Phase 2 Point-in-Time ì—°ê³„)
    {% if not include_target | default(true) %}
    AND event_timestamp <= CURRENT_TIMESTAMP
    {% endif %}
    
    -- ğŸ“Š ë°ì´í„° í’ˆì§ˆ í•„í„°
    AND user_id IS NOT NULL
    AND product_id IS NOT NULL
    AND event_timestamp IS NOT NULL
    AND transaction_amount > 0

ORDER BY 
    user_id, 
    product_id, 
    event_timestamp

-- ğŸ’¡ ì‚¬ìš©ë²•:
-- Training: include_target=true, start_date='2024-01-01', end_date='2024-06-30'
-- Inference: include_target=false, start_date='2024-07-01', end_date='2024-07-31' 