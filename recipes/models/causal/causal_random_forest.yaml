# Causal Random Forest: Robust Tree-Based Causal Inference
# ğŸŒ² Random Forestì˜ ì•ˆì •ì„±ê³¼ Causal inferenceì˜ ì •í™•ì„±ì„ ê²°í•©

name: "causal_random_forest"

model:
  # EconML Causal Forest ì§ì ‘ ë™ì  import
  class_path: "econml.dml.CausalForestDML"
  
  # Phase 1: Point-in-Time ì •í•©ì„± ìŠ¤í‚¤ë§ˆ
  loader:
    name: "campaign_uplift_loader"
    source_uri: "recipes/sql/loaders/uplift_modeling_features.sql"
    adapter: sql
    entity_schema:
      entity_columns: ["customer_id"]
      timestamp_column: "exposure_date"
  
  # ê¸°ì¡´: ML ì‘ì—…ë³„ ì„¸ë¶€ ì„¤ì • (Causal ì „ìš©)
  data_interface:
    task_type: "causal"
    target_column: "purchase_probability"    # êµ¬ë§¤ í™•ë¥  (ì—°ì†í˜•)
    treatment_column: "discount_applied"     # í• ì¸ ì ìš© ì—¬ë¶€ (0/1)
    treatment_value: 1                       # Treatment ê·¸ë£¹ (í• ì¸ ë°›ì€ ê²½ìš°)
    
  # Dictionary í˜•íƒœ í•˜ì´í¼íŒŒë¼ë¯¸í„° (Causal Random Forest íŠ¹í™”)
  hyperparameters:
    # Forest êµ¬ì¡° íŒŒë¼ë¯¸í„°
    n_estimators: {type: "int", low: 100, high: 1000}
    max_depth: {type: "int", low: 5, high: 25}
    min_samples_split: {type: "int", low: 5, high: 50}
    min_samples_leaf: {type: "int", low: 2, high: 20}
    
    # Causal Forest íŠ¹í™” íŒŒë¼ë¯¸í„°
    subsample_fr: {type: "float", low: 0.5, high: 1.0}    # ìƒ˜í”Œë§ ë¹„ìœ¨
    honest: true                                           # Honest ë¶„í•  (Causal inference í•„ìˆ˜)
    
    # í”¼ì²˜ ì„ íƒ
    max_features: {type: "categorical", choices: ["sqrt", "log2", "auto"]}
    
    # ê³ ì •ê°’
    random_state: 42
    n_jobs: -1

  # í•˜ì´í¼íŒŒë¼ë¯¸í„° íŠœë‹ ì„¤ì •
  hyperparameter_tuning:
    enabled: true
    n_trials: 80                    # Causal ForestëŠ” í•™ìŠµì´ ì˜¤ë˜ ê±¸ë¦¼
    metric: "treatment_effect"      # Treatment effectë¡œ ìµœì í™”
    direction: "maximize"
  
  # Feature Store ê¸°ë°˜ í”¼ì²˜ ì¦ê°•
  augmenter:
    type: "feature_store"
    features:
      # ê³ ê° ê°€ê²© ë¯¼ê°ë„
      - feature_namespace: "price_sensitivity"
        features: ["historical_discount_usage", "price_elasticity", "budget_segment"]
      
      # ìƒí’ˆ íŠ¹ì„±
      - feature_namespace: "product_characteristics"
        features: ["base_price", "margin", "competition_level", "seasonality"]
      
      # ì‹œì¥ ì¡°ê±´
      - feature_namespace: "market_conditions"
        features: ["competitor_pricing", "demand_index", "inventory_level"]
      
      # ê³ ê° ì„¸ë¶„í™”
      - feature_namespace: "customer_segments"
        features: ["loyalty_tier", "purchase_frequency", "category_affinity"]

  # ì „ì²˜ë¦¬ ì„¤ì •
  preprocessor:
    name: "causal_preprocessor"
    params:
      criterion_col: null
      exclude_cols: ["customer_id", "product_category", "pricing_test_date", "purchase_probability", "discount_applied"]
      handle_missing: "median"
      scale_features: false        # Random ForestëŠ” ìŠ¤ì¼€ì¼ë§ ë¶ˆí•„ìš”
      encode_categorical: "onehot"

  # í‰ê°€ì ì„¤ì •
  evaluator:
    name: "causal_evaluator"

# í‰ê°€ ì„¤ì •
evaluation:
  metrics:
    - "uplift_auc"
    - "uplift_at_k"
    - "qini_coefficient"
    - "treatment_effect"
  
  validation:
    method: "train_test_split"
    test_size: 0.2
    stratify: true
    random_state: 42
