# =============================================================================
# Dockerfile for {{ project_name }}
# Generated by Modern ML Pipeline
# =============================================================================
# 단일 이미지로 학습, 추론, API 서빙 모두 지원
#
# 빌드:
#   docker build -t {{ project_name }}:latest .
#
# 실행 (command override로 모드 선택):
#   docker run {{ project_name }} mmp serve-api --run-id $RUN_ID -c configs/prod.yaml
#   docker run {{ project_name }} mmp train -r recipes/model.yaml -c configs/prod.yaml -d data/train.csv
#   docker run {{ project_name }} mmp batch-inference --run-id $RUN_ID -c configs/prod.yaml -d data/test.csv
# =============================================================================

###########################################
# Stage 1: Builder - 빌드 도구 + 패키지 설치
###########################################
FROM python:3.11-slim AS builder

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY pyproject.toml README.md ./

# =============================================================================
# 패키지 설치 - 필요한 extras 조합을 선택하세요
# =============================================================================
# 사용 가능한 extras:
#   standard     : XGBoost, scikit-learn, Optuna, SHAP (기본)
#   ml-extras    : LightGBM, CatBoost
#   cloud-extras : BigQuery, GCS, S3
#   torch-extras : PyTorch, LSTM, TabNet
#   causal       : CausalML
#   all          : 위 전체 포함
#
# 조합 예시:
#   ".[standard]"                    - 로컬 개발용 (기본)
#   ".[ml-extras,cloud-extras]"      - 클라우드 배포 + Gradient Boosting
#   ".[cloud-extras,torch-extras]"   - 클라우드 배포 + 딥러닝
#   ".[all]"                         - 전체 기능 (이미지 크기 증가)
# =============================================================================
RUN pip install ".[ml-extras,cloud-extras]"

###########################################
# Stage 2: Runtime - 최종 실행 환경
###########################################
FROM python:3.11-slim AS runtime

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# 빌더에서 설치된 패키지만 복사 (빌드 도구 제외)
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# 보안: 비root 사용자로 실행
RUN groupadd -r mluser && useradd -r -g mluser -d /home/mluser -s /bin/bash mluser

RUN mkdir -p /app/mlruns /app/logs /app/artifacts /app/data /app/configs /app/recipes && \
    chown -R mluser:mluser /app

WORKDIR /app

# 프로젝트 파일 복사 (ConfigMap/Volume으로 override 가능)
COPY --chown=mluser:mluser configs/ ./configs/
COPY --chown=mluser:mluser recipes/ ./recipes/
COPY --chown=mluser:mluser data/ ./data/

USER mluser

ENV PROJECT_NAME={{ project_name }} \
    PYTHONPATH=/app:$PYTHONPATH \
    MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-./mlruns}

EXPOSE 8000

# 헬스체크 (API 서빙 시 사용)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# 기본 명령어: API 서버 (override 가능)
# Kubernetes에서 command/args로 다른 명령어 실행 가능
CMD ["mmp", "--help"]
