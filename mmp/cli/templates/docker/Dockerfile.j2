# =============================================================================
# Dockerfile for {{ project_name }}
# Generated by Modern ML Pipeline
# =============================================================================
# Multi-stage 빌드: 이미지 크기 최소화 (빌드 도구는 최종 이미지에 포함 안 됨)
#
# 빌드 타겟 선택:
#   docker build --target api -t myapp:api .        # API 서버
#   docker build --target training -t myapp:train . # 학습용
#   docker build --target inference -t myapp:infer . # 배치 추론용
# =============================================================================

###########################################
# Stage 1: Base - 공통 Python 환경
###########################################
FROM python:3.11-slim as base

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

###########################################
# Stage 2: Builder - 빌드 도구 + 패키지 설치
###########################################
FROM base as builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

COPY pyproject.toml README.md ./

# 패키지 설치 (필요시 extras 변경: standard, cloud, deep-learning, all 등)
RUN pip install -e ".[standard]"

###########################################
# Stage 3: Runtime - 최종 실행 환경
###########################################
FROM base as runtime

# 빌더에서 설치된 패키지만 복사 (빌드 도구 제외)
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# 보안: 비root 사용자로 실행
RUN groupadd -r mluser && useradd -r -g mluser -d /home/mluser -s /bin/bash mluser

RUN mkdir -p /app/mlruns /app/logs /app/artifacts /app/data && \
    chown -R mluser:mluser /app

WORKDIR /app

# 설정 파일 복사 (읽기 전용으로 마운트 권장)
COPY --chown=mluser:mluser configs/ ./configs/
COPY --chown=mluser:mluser recipes/ ./recipes/
COPY --chown=mluser:mluser sql/ ./sql/
COPY --chown=mluser:mluser data/ ./data/

USER mluser

ENV PROJECT_NAME={{ project_name }} \
    PYTHONPATH=/app:$PYTHONPATH \
    MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-./mlruns}

###########################################
# Stage 4: API - REST API 서버
###########################################
FROM runtime as api

USER root
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*
USER mluser

EXPOSE 8000

# 헬스체크: 60초 후부터 30초 간격으로 /ready 엔드포인트 확인
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/ready || exit 1

# 필수 환경변수: MODEL_RUN_ID (MLflow run ID)
CMD ["sh", "-c", "mmp serve-api --run-id ${MODEL_RUN_ID} --config ${CONFIG_PATH:-configs/production.yaml} --host 0.0.0.0 --port 8000"]

###########################################
# Stage 5: Training - 모델 학습
###########################################
FROM runtime as training

# 필수 환경변수: RECIPE_PATH, TRAIN_DATA_PATH
CMD ["sh", "-c", "mmp train --recipe ${RECIPE_PATH:-recipes/model.yaml} --config ${CONFIG_PATH:-configs/production.yaml} --data ${TRAIN_DATA_PATH:-data/train.csv}"]

###########################################
# Stage 6: Inference - 배치 추론
###########################################
FROM runtime as inference

# 필수 환경변수: MODEL_RUN_ID, INFERENCE_DATA_PATH
CMD ["sh", "-c", "mmp batch-inference --run-id ${MODEL_RUN_ID} --config ${CONFIG_PATH:-configs/production.yaml} --data ${INFERENCE_DATA_PATH}"]

###########################################
# Default: API 서버
###########################################
FROM api as final
